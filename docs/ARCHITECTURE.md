# Academe Infrastructure Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                         PRODUCTION STACK                        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────┐
│   Developer     │
│   Workstation   │
└────────┬────────┘
         │
         │ git push
         ▼
┌─────────────────────────────────────────────────────────────────┐
│                         GITHUB                                   │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                  GitHub Actions CI/CD                      │ │
│  │                                                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │ │
│  │  │  Test        │  │  Build       │  │  Security    │   │ │
│  │  │  Backend     │  │  Docker      │  │  Scan        │   │ │
│  │  │  (pytest)    │  │  Images      │  │  (Bandit)    │   │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │ │
│  │                                                            │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │ │
│  │  │  Test        │  │  Code        │  │  Coverage    │   │ │
│  │  │  Frontend    │  │  Quality     │  │  Report      │   │ │
│  │  │  (lint)      │  │  (Black)     │  │  (Codecov)   │   │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              │ Push Images                       │
│                              ▼                                   │
│                      ┌──────────────┐                           │
│                      │  Docker Hub  │                           │
│                      └──────────────┘                           │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ Deploy
                              ▼

┌─────────────────────────────────────────────────────────────────┐
│                      AWS EC2 INSTANCE                            │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Docker Compose                          │ │
│  │                                                            │ │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐ │ │
│  │  │ Frontend │  │ Backend  │  │  Celery  │  │  Redis   │ │ │
│  │  │ (Next.js)│  │ (FastAPI)│  │  Worker  │  │          │ │ │
│  │  │  Port    │  │  Port    │  │          │  │ Port     │ │ │
│  │  │  3000    │  │  8000    │  │          │  │ 6379     │ │ │
│  │  └─────┬────┘  └─────┬────┘  └─────┬────┘  └─────┬────┘ │ │
│  │        │             │             │             │        │ │
│  │        └─────────────┴─────────────┴─────────────┘        │ │
│  │                      │                                     │ │
│  │                      │ academe_network                     │ │
│  │                      │                                     │ │
│  │                      ▼                                     │ │
│  │              ┌──────────────┐                             │ │
│  │              │   MongoDB    │                             │ │
│  │              │   Port 27017 │                             │ │
│  │              └──────────────┘                             │ │
│  │                                                            │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                     Nginx Reverse Proxy                    │ │
│  │                                                            │ │
│  │  HTTP/HTTPS → Frontend (/)                                │ │
│  │  HTTP/HTTPS → Backend (/api)                              │ │
│  │  WebSocket  → Backend (/ws)                               │ │
│  └────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ Metrics
                              ▼

┌─────────────────────────────────────────────────────────────────┐
│                         MONITORING                               │
│                                                                  │
│  ┌──────────────┐        ┌──────────────┐                      │
│  │  Prometheus  │───────▶│   Grafana    │                      │
│  │  Metrics DB  │        │  Dashboard   │                      │
│  │  Port 9090   │        │  Port 3001   │                      │
│  └──────────────┘        └──────────────┘                      │
└─────────────────────────────────────────────────────────────────┘

                              │
                              │ Vector Search
                              ▼

┌─────────────────────────────────────────────────────────────────┐
│                      EXTERNAL SERVICES                           │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │  Pinecone    │  │ MongoDB      │  │   Codecov    │         │
│  │  Vector DB   │  │ Atlas        │  │   Coverage   │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────┘
```

---

## Multi-Stage Docker Build Flow

```
┌─────────────────────────────────────────────────────────────────┐
│                      BACKEND DOCKERFILE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Stage 1: BASE                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM python:3.11-slim                                      │ │
│  │ Install system dependencies (gcc, g++)                     │ │
│  │ COPY requirements.txt                                      │ │
│  │ RUN pip install -r requirements.txt                        │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│  Stage 2: TEST                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM base                                                  │ │
│  │ COPY entire backend                                        │ │
│  │ Install test dependencies (pytest, pytest-cov)            │ │
│  │ RUN pytest tests/unit/ -v --cov                           │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│  Stage 3: PRODUCTION                                            │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM base                                                  │ │
│  │ COPY --from=test /app /app                                │ │
│  │ Create non-root user (academe)                            │ │
│  │ USER academe                                               │ │
│  │ EXPOSE 8000                                                │ │
│  │ HEALTHCHECK http://localhost:8000/health                  │ │
│  │ CMD uvicorn api.main:app --host 0.0.0.0 --port 8000       │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Result: 60% smaller image, tests passed, non-root user        │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                     FRONTEND DOCKERFILE                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Stage 1: DEPS                                                  │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM node:20-alpine                                        │ │
│  │ COPY package.json package-lock.json                        │ │
│  │ RUN npm ci --only=production                               │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│  Stage 2: BUILDER                                               │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM node:20-alpine                                        │ │
│  │ COPY --from=deps /app/node_modules ./node_modules         │ │
│  │ COPY application code                                      │ │
│  │ RUN npm run build                                          │ │
│  └────────────────────────────────────────────────────────────┘ │
│                              │                                   │
│                              ▼                                   │
│  Stage 3: PRODUCTION                                            │
│  ┌────────────────────────────────────────────────────────────┐ │
│  │ FROM node:20-alpine                                        │ │
│  │ Create non-root user (nextjs)                             │ │
│  │ COPY --from=builder /app/.next ./.next                    │ │
│  │ COPY --from=builder /app/public ./public                  │ │
│  │ USER nextjs                                                │ │
│  │ EXPOSE 3000                                                │ │
│  │ CMD node server.js                                         │ │
│  └────────────────────────────────────────────────────────────┘ │
│                                                                  │
│  Result: Optimized build, static assets, non-root user         │
└─────────────────────────────────────────────────────────────────┘
```

---

## CI/CD Pipeline Flow

```
Developer Push to GitHub
         │
         ▼
┌──────────────────────────────────────────────────────────┐
│              GitHub Actions Triggered                    │
└──────────────────────────────────────────────────────────┘
         │
         ├──────────────┬──────────────┬──────────────┐
         ▼              ▼              ▼              ▼
    ┌────────┐    ┌────────┐    ┌────────┐    ┌────────┐
    │Backend │    │Frontend│    │ Code   │    │Security│
    │ Tests  │    │ Build  │    │Quality │    │ Scan   │
    └────────┘    └────────┘    └────────┘    └────────┘
         │              │              │              │
         │              │              │              │
         └──────────────┴──────────────┴──────────────┘
                        │
                        ▼
                    All Pass? 
                        │
         ┌──────────────┴──────────────┐
         ▼                             ▼
    ┌────────┐                   ┌────────┐
    │Coverage│                   │ Build  │
    │Report  │                   │Docker  │
    │Codecov │                   │Images  │
    └────────┘                   └────────┘
                                      │
                                      ▼
                               ┌─────────────┐
                               │ Push to     │
                               │ Docker Hub  │
                               └─────────────┘
                                      │
                                      ▼
                               Ready to Deploy! 
```

---

## Metrics Collection Flow

```
┌──────────────────────────────────────────────────────────┐
│                    User Request                          │
└──────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│                  Nginx Reverse Proxy                     │
│                  (Port 80/443)                           │
└──────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│              FastAPI Backend (Port 8000)                 │
│                                                          │
│  ┌────────────────────────────────────────────────────┐ │
│  │         Prometheus Instrumentator                  │ │
│  │                                                    │ │
│  │  Tracks:                                          │ │
│  │  • Request count                                  │ │
│  │  • Response time (p50, p95, p99)                 │ │
│  │  • Error rate                                     │ │
│  │  • Requests in progress                          │ │
│  │  • Status codes                                   │ │
│  └────────────────────────────────────────────────────┘ │
│                        │                                 │
│                        ▼                                 │
│              /metrics endpoint                          │
│          (Prometheus format)                            │
└──────────────────────────────────────────────────────────┘
                        │
                        │ Scrape every 15s
                        ▼
┌──────────────────────────────────────────────────────────┐
│                Prometheus (Port 9090)                    │
│                                                          │
│  • Time-series database                                 │
│  • Stores 15 days of metrics                           │
│  • Query language (PromQL)                             │
└──────────────────────────────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│                Grafana (Port 3001)                       │
│                                                          │
│  • Visual dashboards                                    │
│  • Real-time graphs                                     │
│  • Alerting rules                                       │
└──────────────────────────────────────────────────────────┘
```

